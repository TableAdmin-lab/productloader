<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Table By Yoco Product Loader</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%2300A3FF'/%3E%3Ctext x='50' y='70' font-size='50' font-family='Poppins, sans-serif' font-weight='bold' fill='white' text-anchor='middle'%3EY%3C/text%3E%3C/svg%3E">
  <script src="config.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --yoco-bg: #121212; --yoco-surface: #1e1e1e; --yoco-primary: #00A3FF;
      --yoco-primary-hover: #008bdf; --yoco-text-primary: #FFFFFF; --yoco-text-secondary: #b3b3b3;
      --yoco-border: #333333; --yoco-red: #eb5757; --yoco-yellow: #ffc107;
      --yoco-green: #27ae60; --shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif; margin: 0; padding: 20px;
      background-color: var(--yoco-bg); color: var(--yoco-text-primary); position: relative;
    }
    .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
    
    .library-item, .ocr-item {
        display: flex; justify-content: space-between; align-items: center; padding: 12px;
        border-radius: 8px; background-color: #2a2a2a; margin-bottom: 10px;
    }
    .library-item-info, .ocr-item-info { flex-grow: 1; margin-right: 15px; }
    .library-item-name, .ocr-item-name { font-weight: 600; }
    .library-item-details, .ocr-item-details { font-size: 13px; color: var(--yoco-text-secondary); }
    .library-item-actions, .ocr-item-actions { display: flex; gap: 10px; flex-shrink: 0; }
    .library-item-actions button, .ocr-item-actions button { font-size: 13px; padding: 6px 12px; }

    header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 40px; position: relative; flex-wrap: wrap;
    }
    header h2 {
        font-size: 2.5rem; font-weight: 700; margin: 0;
        background: linear-gradient(45deg, var(--yoco-primary), #fff);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    #secretTrigger {
        cursor: pointer;
        user-select: none;
    }
    #saveStatus {
        position: absolute; top: 5px; left: 50%; transform: translateX(-50%);
        background-color: var(--yoco-green); color: var(--yoco-text-primary);
        padding: 5px 15px; border-radius: 20px; font-size: 14px;
        font-weight: 500; opacity: 0; transition: opacity 0.5s ease-in-out;
        pointer-events: none;
    }
    .session-settings {
        background-color: var(--yoco-surface); border: 1px solid var(--yoco-border);
        border-radius: 16px; padding: 30px; margin-bottom: 40px;
        display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 25px; align-items: end;
    }
    .session-settings h3 { grid-column: 1 / -1; margin: 0 0 10px 0; color: var(--yoco-primary); }
    form {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px; padding: 30px; background-color: var(--yoco-surface);
      border: 1px solid var(--yoco-border); border-radius: 16px; box-shadow: var(--shadow);
      margin-bottom: 40px;
    }
    .form-group { display: flex; flex-direction: column; }
    .dynamic-section {
        grid-column: 1 / -1; display: flex; flex-direction: column;
        gap: 15px; border-top: 1px solid var(--yoco-border); padding-top: 20px;
    }
    .variants-and-pricing-wrapper {
        grid-column: 1 / -1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
        align-items: start;
        border-top: 1px solid var(--yoco-border);
        padding-top: 20px;
    }
    #variants-column > div { margin-bottom: 20px; }
    .variant-group-row, .modifier-group-row {
        background-color: #2a2a2a; padding: 15px; border-radius: 8px;
        border: 1px solid var(--yoco-border); display: flex; flex-direction: column; gap: 10px;
    }
    .variant-group-header, .modifier-group-header { display: flex; gap: 10px; align-items: center; }
    .variant-group-header input, .modifier-group-header input { flex-grow: 1; }
    .variant-option-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; padding-left: 20px;}
    .modifier-option-row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: center; padding-left: 20px;}
    .variant-pricing-row { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: center; padding-left: 20px;}
    .variant-pricing-row .combo-name { font-size: 14px; color: var(--yoco-text-secondary); }
    
    .btn-add-dynamic { align-self: flex-start; padding: 8px 16px; font-size: 14px; }
    .dynamic-controls-wrapper { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    #single-product-modifier-controls { display: flex; gap: 10px; align-items: center; }
    .form-actions-footer {
        display: flex; justify-content: flex-end; align-items: center;
        margin-top: 10px; grid-column: 1 / -1;
    }
    label { font-weight: 500; margin-bottom: 10px; font-size: 14px; color: var(--yoco-text-secondary); }
    label .required-star { color: var(--yoco-primary); font-weight: bold; margin-left: 2px; }
    input, select, textarea {
      padding: 14px; border-radius: 8px; border: 1px solid var(--yoco-border);
      background-color: #2a2a2a; color: var(--yoco-text-primary);
      font-size: 16px; font-family: 'Poppins', sans-serif;
      transition: border-color 0.2s, box-shadow 0.2s; resize: vertical;
    }
    input:disabled, select:disabled, textarea:disabled { background-color: #333; cursor: not-allowed; }
    select:invalid { color: var(--yoco-text-secondary); }
    input:focus, select:focus, textarea:focus {
        outline: none; border-color: var(--yoco-primary);
        box-shadow: 0 0 0 3px rgba(0, 163, 255, 0.3);
    }
    input::placeholder, textarea::placeholder { color: var(--yoco-text-secondary); opacity: 0.7; }
    .table-container {
        overflow-x: auto; background-color: var(--yoco-surface);
        border: 1px solid var(--yoco-border); border-radius: 16px; box-shadow: var(--shadow);
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 16px 20px; text-align: left; border-bottom: 1px solid var(--yoco-border); font-size: 14px; white-space: nowrap; }
    tr:last-child td { border-bottom: none; }
    th {
      background: #2a2a2a; font-weight: 600; color: var(--yoco-text-primary);
      text-transform: uppercase; font-size: 12px; letter-spacing: 0.8px;
    }
    tbody tr { transition: background-color 0.5s ease-in-out; }
    tbody tr:hover { background-color: #2c2c2c; }
    tbody tr.new-row { background-color: rgba(0, 163, 255, 0.2); }
    tbody tr.editing-row { background-color: rgba(255, 193, 7, 0.2); }
    button {
      padding: 14px 28px; border: none; border-radius: 8px; cursor: pointer;
      font-size: 16px; font-weight: 600; font-family: 'Poppins', sans-serif;
      transition: all 0.2s ease-in-out;
    }
    button:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
    .btn-add, .btn-update { background: var(--yoco-primary); color: var(--yoco-text-primary); }
    .btn-add:hover, .btn-update:hover { background: var(--yoco-primary-hover); }
    .btn-export, .btn-import { background: transparent; color: var(--yoco-primary); border: 2px solid var(--yoco-primary); }
    .btn-export:hover, .btn-import:hover { background: var(--yoco-primary); color: var(--yoco-text-primary); }
    .btn-clear {
        background: transparent; color: var(--yoco-red); border: 2px solid var(--yoco-red); padding: 12px 14px;
    }
    .btn-clear:hover { background: var(--yoco-red); color: var(--yoco-text-primary); }
    .btn-clear svg, .btn-edit svg, .btn-remove svg { transition: fill 0.2s; }
    .btn-clear svg { fill: var(--yoco-red); }
    .btn-clear:hover svg { fill: var(--yoco-text-primary); }
    .btn-edit, .btn-remove {
      background-color: transparent; padding: 5px; border-radius: 50%;
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
    }
    .btn-edit svg, .btn-remove svg { fill: var(--yoco-text-secondary); }
    .btn-edit:hover svg { fill: var(--yoco-primary); }
    .btn-remove:hover svg { fill: var(--yoco-red); }
    .btn-edit:hover { background-color: rgba(0, 163, 255, 0.1); transform: none; box-shadow: none;}
    .btn-remove:hover { background-color: rgba(235, 87, 87, 0.1); transform: none; box-shadow: none; }
    .actions-cell { display: flex; gap: 8px; }
    .button-container { margin-top: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
    .tooltip { position: relative; cursor: help; border-bottom: 1px dotted var(--yoco-text-secondary); }
    .tooltip .tooltiptext {
      visibility: hidden; width: 280px; background-color: #2a2a2a; color: var(--yoco-text-primary);
      text-align: left; padding: 12px; border-radius: 8px; border: 1px solid var(--yoco-border);
      position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -140px; opacity: 0;
      transition: opacity 0.3s; font-weight: 400; font-size: 13px; line-height: 1.6;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .tooltip .tooltiptext::after {
      content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
      border-width: 5px; border-style: solid; border-color: #2a2a2a transparent transparent transparent;
    }
    .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    .table-footer { display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px; }
    
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(18, 18, 18, 0.85);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        display: flex; justify-content: center; align-items: center;
        z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .modal-overlay.show { opacity: 1; pointer-events: auto; }
    .modal-content {
        background-color: var(--yoco-surface);
        padding: 30px; border-radius: 16px; min-width: 320px; max-width: 500px; text-align: center;
        transform: scale(0.9); transition: transform 0.3s ease;
        border: 1px solid var(--yoco-border);
    }
    .modal-overlay.show .modal-content { transform: scale(1); }
    .modal-content p { margin: 0 0 20px 0; font-size: 16px; line-height: 1.6; white-space: pre-wrap; }
    .modal-actions { display: flex; justify-content: center; gap: 15px; }
    .modal-content.error { background-color: #441c24; color: #f8d7da; border: 1px solid var(--yoco-red); }
    .modal-content.warning { background-color: #4d421a; color: #fff3cd; border: 1px solid var(--yoco-yellow); }
    
    #ocrModal .modal-content, #libraryModal .modal-content, #modifierModal .modal-content, #linkModifierModal .modal-content, #variantDetailModal .modal-content { 
        max-width: 800px; text-align: left; 
    }
    #editModifierGroupsContainer, #ocrResultsContainer, #libraryListContainer, #linkModifierListContainer, #variantDetailListContainer { 
        max-height: 40vh; overflow-y: auto; padding-right: 10px;
    }
    #libraryListContainer table, #variantDetailListContainer table {
        border-collapse: collapse;
        width: 100%;
    }
    #libraryListContainer th, #libraryListContainer td, #variantDetailListContainer th, #variantDetailListContainer td {
        border: none;
        border-bottom: 1px solid var(--yoco-border);
        padding: 12px 8px;
    }
    .modal-section-divider {
        border-bottom: 1px solid var(--yoco-border);
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    #linkModifierListContainer .modifier-link-item {
        display: flex; align-items: center; gap: 15px; padding: 8px;
    }
    #linkModifierListContainer .modifier-link-item:hover { background-color: #2a2a2a; border-radius: 4px; }
    #linkModifierListContainer .modifier-link-item input[type="checkbox"] { width: 18px; height: 18px; }

    #ocrDropzone {
      border: 2px dashed var(--yoco-border); border-radius: 8px; padding: 40px;
      text-align: center; cursor: pointer; transition: background-color 0.2s;
    }
    #ocrDropzone:hover { background-color: #2a2a2a; }
    
    .modifier-indicator {
        display: inline-flex; justify-content: center; align-items: center;
        width: 22px; height: 22px;
        background-color: var(--yoco-green); color: white; border-radius: 50%;
        font-size: 12px; font-weight: 600;
        flex-shrink: 0;
    }
    .modifier-indicator-wrapper.tooltip { border-bottom: none; }
    .modifier-indicator-wrapper .tooltiptext { min-width: 150px; margin-left: -75px; }

    .pricing-controls {
        display: flex; gap: 10px; align-items: center;
        margin-bottom: 15px; padding: 10px;
        background-color: #2a2a2a; border-radius: 8px;
    }
    .pricing-controls input { flex-grow: 1; }

    .tooltip .tooltiptext.with-gif {
        width: 850px;
        margin-left: -225px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .tooltip-text-content {
        flex: 1;
    }
    .tooltip-gif {
        width: 1000px;
        height: 500;
        border-radius: 6px;
    }

    @media (max-width: 992px) {
        .variants-and-pricing-wrapper {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        body { padding: 10px; }
        .container { padding: 10px; }
        header { flex-direction: column; align-items: flex-start; gap: 20px; }
        header h2 { font-size: 2rem; }
        .session-settings, form { padding: 20px; grid-template-columns: 1fr; }
        .variant-group-header, .variant-option-row, .variant-pricing-row, .modifier-group-header, .modifier-option-row { grid-template-columns: 1fr; gap: 15px; }
        th, td { padding: 12px 10px; font-size: 13px; }
        .button-container { width: 100%; flex-direction: column; }
        .button-container button { width: 100%; }
        .form-actions-footer { justify-content: center; }
        .form-actions-footer button { width: 100%; }
    }
  </style>
</head>
<body>

<div class="container">
    <header>
        <h2><span id="secretTrigger" title="Unlock advanced features">T</span>able By Yoco Product Loader</h2>
        <span id="saveStatus">Saved!</span>
        <div class="button-container">
            <div id="secretActionsContainer" style="display: none; gap: 15px; flex-wrap: wrap;">
                <button type="button" id="importMenuBtn" class="btn-import">Import Menu</button>
                <button type="button" id="openLibraryBtn" class="btn-import">Item Library</button>
            </div>
            <button type="button" onclick="exportToExcel()" class="btn-export">Export to Excel</button>
            <button type="button" onclick="confirmClearAll()" class="btn-clear" title="Clear All Data">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M3 6v18h18v-18h-18zm5 14c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm4-18h-20v-2h6v-1.5c0-.827.673-1.5 1.5-1.5h5c.825 0 1.5.671 1.5 1.5v1.5h6v2z"/></svg>
            </button>
        </div>
    </header>

    <div class="session-settings">
        <h3>Session Defaults</h3>
        <div class="form-group">
            <label for="sessionSite" class="tooltip">Site<span class="required-star">*</span></label>
            <input list="siteList" id="sessionSite" required placeholder="e.g., Main Street Cafe">
            <datalist id="siteList"></datalist>
        </div>
        <div class="form-group">
            <label for="sessionDefinePlu" class="tooltip">Define PLU/SKU?<span class="required-star">*</span></label>
            <select id="sessionDefinePlu">
                <option value="no">No (Auto-generate)</option>
                <option value="yes">Yes (Manual Entry)</option>
            </select>
        </div>
        <div class="form-group">
            <button type="button" id="defaultsButton" onclick="setDefaults()" class="btn-add">Set Defaults</button>
        </div>
    </div>

    <form id="productForm" novalidate>
        <input type="hidden" id="editingIndex" value="-1">
        <div class="form-group">
            <label for="productName" class="tooltip">Product Name<span class="required-star">*</span></label>
            <input type="text" id="productName" required placeholder="e.g., Chicken Pizza">
            <div id="single-product-modifier-controls" style="display: none; margin-top: 10px;">
                <button type="button" id="linkSingleModifierBtn" class="btn-add btn-add-dynamic">Link Modifier</button>
                <span id="singleModifierIndicator"></span>
            </div>
        </div>
        
        <div class="form-group">
            <label for="taxApplicable" class="tooltip">Tax Applicable<span class="required-star">*</span></label>
            <select id="taxApplicable" required>
                <option value="" disabled selected>-- Choose --</option>
                <option value="true">TRUE</option>
                <option value="false">FALSE</option>
            </select>
        </div>

        <div class="form-group">
            <label for="productType" class="tooltip">Product Type<span class="required-star">*</span></label>
            <select id="productType" required>
                <option value="" disabled selected>-- Select --</option>
                <option value="finishedGood">finishedGood</option>
                <option value="rawMaterial">rawMaterial</option>
                <option value="finishedGood & rawMaterial">finishedGood & rawMaterial</option>
                <option value="Manufactured">Manufactured</option>
            </select>
        </div>

        <div class="form-group" id="sellingPriceGroup">
            <label for="sellingPrice" id="sellingPriceLabel" class="tooltip">Default Selling Price (if no variants)</label>
            <input type="number" step="0.01" id="sellingPrice" placeholder="e.g., 35.00">
        </div>

        <div class="form-group" id="pluEntryGroup" style="display: none;">
            <label for="customPlu" class="tooltip">Custom Base PLU/SKU<span class="required-star">*</span></label>
            <input type="text" id="customPlu" placeholder="e.g., PIZZA-CHE">
        </div>
        
        <div class="variants-and-pricing-wrapper">
            <div id="variants-column">
                <div> <label class="tooltip">Variant Groups
                        <span class="tooltiptext with-gif">
                            <span class="tooltip-text-content">Create groups for product options like size or color. Each group can have multiple options.</span>
                            <img src="variant-groups-demo.gif" alt="Variant groups demo" class="tooltip-gif">
                        </span>
                    </label>
                    <div id="variantGroupsContainer"></div>
                    <div class="dynamic-controls-wrapper">
                         <button type="button" id="addVariantGroupBtn" onclick="addVariantGroup()" class="btn-add btn-add-dynamic">Add Variant Group</button>
                    </div>
                </div>
                <div> <label class="tooltip">Modifier Groups
                        <span class="tooltiptext">Create optional add-ons (e.g., Extra Toppings) and link them to products or variants.</span>
                     </label>
                     <div class="dynamic-controls-wrapper">
                        <button type="button" id="openModifierModalBtn" class="btn-add btn-add-dynamic">Add/Edit Modifiers</button>
                    </div>
                </div>
            </div>
            <div id="pricing-column" style="display: none;">
                <label class="tooltip">Combination Pricing
                    <span class="tooltiptext">Set the price for each unique combination of variants. A selling price is required for each.</span>
                </label>
                <div id="variantPricingContainer"></div>
            </div>
        </div>

        <div class="form-group">
            <label for="uom" class="tooltip">UOM<span class="required-star">*</span></label>
            <select id="uom" required>
            <option value="" disabled>-- Select UOM --</option>
            <option value="ea" selected>Each</option>
            <option value="kg">Kilograms</option><option value="g">Grams</option>
            <option value="l">Litres</option><option value="ml">Millilitres</option>
            <option value="m">Meters</option><option value="mm">Millimeters</option>
            <option value="cm">Centimeters</option>
            </select>
        </div>

        <div class="form-group" id="prepLocationGroup">
            <label for="prepLocation" class="tooltip">Prep Location<span class="required-star">*</span></label>
            <input list="prepList" id="prepLocation" required placeholder="e.g., Kitchen">
            <datalist id="prepList"></datalist>
        </div>

        <div class="form-group" id="menuCategoryGroup">
            <label for="menuCategory" class="tooltip">Menu Category<span class="required-star">*</span></label>
            <input type="text" id="menuCategory" list="menuList" required placeholder="e.g., Burgers">
            <datalist id="menuList"></datalist>
        </div>
        
        <div class="form-group">
            <label for="inventoryCategory" id="inventoryCategoryLabel" class="tooltip">Inventory Category</label>
            <input type="text" id="inventoryCategory" list="inventoryCategoryList" placeholder="e.g., Food">
            <datalist id="inventoryCategoryList"></datalist>
        </div>

        <div class="form-group">
            <label for="inventorySubCategory" id="inventorySubCategoryLabel" class="tooltip">Inventory Sub-Category</label>
            <input type="text" id="inventorySubCategory" list="inventorySubCategoryList" placeholder="e.g., Meat">
            <datalist id="inventorySubCategoryList"></datalist>
        </div>
        
        <div class="form-group" id="suppliedQuantityGroup" style="display: none;">
            <label for="suppliedQuantity" id="suppliedQuantityLabel" class="tooltip">Supplied Quantity</label>
            <input type="number" id="suppliedQuantity" placeholder="e.g., 100">
        </div>
        
        <div class="form-group" id="yieldQuantityGroup" style="display: none;">
            <label for="yieldQuantity" id="yieldQuantityLabel" class="tooltip">Yield Quantity</label>
            <input type="number" id="yieldQuantity" placeholder="e.g., 50">
        </div>

        <div class="form-group" id="costPriceGroup">
            <label for="costPrice" id="costPriceLabel" class="tooltip">Default Cost Price</label>
            <input type="number" step="0.01" id="costPrice" placeholder="e.g., 15.50">
        </div>

        <div class="form-group">
            <label for="hasBarcode" class="tooltip">Has Barcode?</label>
            <select id="hasBarcode"> <option value="no">No</option> <option value="yes">Yes</option> </select>
        </div>

        <div class="form-group" id="barcodeEntryGroup" style="display: none;">
            <label for="barcode" class="tooltip">Barcode</label>
            <input type="text" id="barcode" placeholder="Enter product barcode">
        </div>
        
        <div class="form-actions-footer">
            <button type="button" id="mainActionButton" class="btn-add">Add Product</button>
        </div>
    </form>

    <div class="table-container">
        <table id="productTable">
          <thead>
            <tr>
              <th>PLU</th><th>Product Name</th><th>Variant</th><th>Site</th><th>GP</th><th>UOM</th>
              <th>Prep Location</th><th>Menu Category</th><th>Inv Category</th><th>Inv Sub-Category</th>
              <th>Product Type</th><th>Enabled</th><th>Cost Price</th><th>Selling Price</th><th>Taxable</th>
              <th>Modifier</th><th>Barcode</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="table-footer">
            <button type="button" onclick="updateTable()" class="btn-import">Refresh List</button>
            <button type="button" onclick="exportToExcel()" class="btn-export">Export to Excel</button>
        </div>
    </div>
</div>

<div id="customModal" class="modal-overlay">
  <div class="modal-content">
    <p id="modalMessage"></p>
    <div id="modalActions" class="modal-actions"></div>
  </div>
</div>

<div id="ocrModal" class="modal-overlay">
  <div class="modal-content">
    <h3 style="color: var(--yoco-primary); margin-top: 0;">Import Menu</h3>
    <div id="ocrLoader" style="display: none; text-align: center; margin: 20px 0;">
        <img id="loaderGif1" src="loader.gif" alt="Processing Menu..." style="width: 150px; margin: auto; border-radius: 8px; display: none;">
        <img id="loaderGif2" src="loader2.gif" alt="Processing Menu..." style="width: 150px; margin: auto; border-radius: 8px; display: none;">
        <p id="ocrStatus" style="color: var(--yoco-text-secondary); margin-top: 15px;"></p>
    </div>
    <div id="ocrDropzone" style="margin-top: 20px;">
        <p>Drag & Drop a file here or click to select</p>
        <input type="file" id="ocr-file-upload" class="sr-only" accept="image/*,application/pdf" style="display:none;">
    </div>
    <div id="ocrResultsContainer"></div>
    <div class="modal-actions" style="margin-top: 20px;">
        <button type="button" id="closeOcrModalBtn" class="btn-export">Close</button>
    </div>
  </div>
</div>

<div id="libraryModal" class="modal-overlay">
  <div class="modal-content">
    <h3 style="color: var(--yoco-primary); margin-top: 0;">Item Library</h3>
    <p style="color: var(--yoco-text-secondary);">Add a previously scanned item to the form, or add it directly to your product list.</p>
    <input type="search" id="librarySearch" placeholder="Search library..." style="margin-bottom: 20px; width: 100%;">
    <div id="libraryListContainer"></div>
    <div class="modal-actions" style="margin-top: 20px;">
        <button type="button" id="closeLibraryModalBtn" class="btn-export">Close</button>
    </div>
  </div>
</div>

<div id="variantDetailModal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="variantDetailModalTitle" style="color: var(--yoco-primary); margin-top: 0;">Variants for...</h3>
    <div id="variantDetailListContainer">
    </div>
    <div class="modal-actions" style="margin-top: 20px;">
        <button type="button" id="closeVariantDetailModalBtn" class="btn-export">Close</button>
    </div>
  </div>
</div>

<div id="modifierModal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="color: var(--yoco-primary); margin-top: 0;">Manage Modifier Groups</h3>
      
      <div class="modal-section-divider">
        <h4>Add New Modifier Group</h4>
        <div id="newModifierGroupForm" class="modifier-group-row">
            </div>
      </div>

      <h4>Edit Existing Groups</h4>
      <div id="editModifierGroupsContainer">
        </div>

      <div class="modal-actions" style="margin-top: 20px;">
          <button type="button" id="saveModifiersBtn" class="btn-add">Save and Close</button>
          <button type="button" id="closeModifierModalBtn" class="btn-export">Cancel</button>
      </div>
    </div>
</div>

<div id="linkModifierModal" class="modal-overlay">
  <div class="modal-content">
    <h4 id="linkModifierModalTitle" style="color: var(--yoco-primary); margin-top: 0; margin-bottom: 20px;">Link Modifiers for...</h4>
    
    <div class="modal-section-divider">
        <h4>Bulk Apply to All Variants on Form</h4>
        <div style="display: flex; gap: 10px; align-items: center; padding: 10px 0;">
            <select id="bulkModifierSelect" style="flex-grow: 1;"></select>
            <button type="button" id="bulkApplyModifierBtn" class="btn-add-dynamic">Apply to All</button>
        </div>
    </div>

    <div id="linkModifierListContainer">
      </div>
    <div class="modal-actions" style="margin-top: 20px;">
      <button type="button" id="closeLinkModifierModalBtn" class="btn-add">Done</button>
    </div>
  </div>
</div>

<audio id="exportSound" src="tableaudio.mp3" preload="auto"></audio>

<div id="videoOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: black; z-index: 2000; justify-content: center; align-items: center;">
  <video id="exportVideo" width="600" style="max-width: 90%; max-height: 90%;" playsinline>
    <source src="animated-logo.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>
</div>

<script>
// --- GLOBAL STATE ---
let products = [];
let pluCounter = 1000;
let currentModifierGroups = [];
let currentModifierLinks = {};
let currentVariantGroups = [];
let currentVariantPricing = [];
let sessionSite = '';
let sessionDefinePlu = 'no';
let defaultsSet = false;
let itemLibrary = [];
let loaderInterval = null;

const categoryMap = {
    "Food": ["Meat", "Dairy", "Produce", "Bakery", "Dry Goods", "Frozen"],
    "Beverages": ["Sodas", "Juices", "Alcohol", "Coffee & Tea", "Water"],
    "Packaging": ["Containers", "Bags", "Cutlery", "Napkins"], "Supplies": ["Cleaning", "Office", "Uniforms"]
};

// --- DOM Elements ---
const exportSoundElement = document.getElementById('exportSound');
const sessionSiteInput = document.getElementById('sessionSite');
const sessionDefinePluSelect = document.getElementById('sessionDefinePlu');
const defaultsButton = document.getElementById('defaultsButton');
const pluEntryGroup = document.getElementById('pluEntryGroup');
const productTypeSelect = document.getElementById('productType');
const costPriceGroup = document.getElementById('costPriceGroup');
const sellingPriceGroup = document.getElementById('sellingPriceGroup');
const inventoryCategoryInput = document.getElementById('inventoryCategory');
const hasBarcodeSelect = document.getElementById('hasBarcode');
const barcodeEntryGroup = document.getElementById('barcodeEntryGroup');
const saveStatus = document.getElementById('saveStatus');
const variantGroupsContainer = document.getElementById('variantGroupsContainer');
const pricingColumn = document.getElementById('pricing-column');
const variantPricingContainer = document.getElementById('variantPricingContainer');
const addVariantGroupBtn = document.getElementById('addVariantGroupBtn');
const customModal = document.getElementById('customModal');
const modalMessage = document.getElementById('modalMessage');
const modalActions = document.getElementById('modalActions');
const mainActionButton = document.getElementById('mainActionButton');
const editingIndexInput = document.getElementById('editingIndex');
const libraryModal = document.getElementById('libraryModal');
const libraryListContainer = document.getElementById('libraryListContainer');
const librarySearchInput = document.getElementById('librarySearch');
const ocrModal = document.getElementById('ocrModal');
const ocrLoader = document.getElementById('ocrLoader');
const ocrStatus = document.getElementById('ocrStatus');
const ocrDropzone = document.getElementById('ocrDropzone');
const ocrFileInput = document.getElementById('ocr-file-upload');
const ocrResultsContainer = document.getElementById('ocrResultsContainer');
const modifierModal = document.getElementById('modifierModal');
const newModifierGroupForm = document.getElementById('newModifierGroupForm');
const editModifierGroupsContainer = document.getElementById('editModifierGroupsContainer');
const linkModifierModal = document.getElementById('linkModifierModal');
const linkModifierModalTitle = document.getElementById('linkModifierModalTitle');
const linkModifierListContainer = document.getElementById('linkModifierListContainer');
const variantDetailModal = document.getElementById('variantDetailModal');
const singleProductModifierControls = document.getElementById('single-product-modifier-controls');


// --- Event Listeners ---
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    updateRequiredFields();
    document.getElementById('secretTrigger').addEventListener('click', () => {
        const secretContainer = document.getElementById('secretActionsContainer');
        if (secretContainer.style.display === 'none') {
            secretContainer.style.display = 'flex';
        } else {
            secretContainer.style.display = 'none';
        }
    });
});
mainActionButton.addEventListener('click', handleMainAction);
librarySearchInput.addEventListener('input', (e) => populateStaticLibraryList(e.target.value));
sessionDefinePluSelect.addEventListener('change', () => { if (defaultsSet) { sessionDefinePlu = sessionDefinePluSelect.value; handlePluVisibility(); } });
productTypeSelect.addEventListener('change', () => {
    updateRequiredFields();
    renderVariantGroups();
});
inventoryCategoryInput.addEventListener('input', handleInventoryCategoryChange);
hasBarcodeSelect.addEventListener('change', handleBarcodeVisibility);
document.getElementById('importMenuBtn').addEventListener('click', () => {
    ocrModal.classList.add('show');
    ocrResultsContainer.innerHTML = '';
    ocrLoader.style.display = 'none';
    ocrDropzone.style.display = 'block';
});
document.getElementById('openLibraryBtn').addEventListener('click', () => {
    populateStaticLibraryList();
    libraryModal.classList.add('show');
});
document.getElementById('closeOcrModalBtn').addEventListener('click', () => ocrModal.classList.remove('show'));
document.getElementById('closeLibraryModalBtn').addEventListener('click', () => libraryModal.classList.remove('show'));
document.getElementById('closeVariantDetailModalBtn').addEventListener('click', () => variantDetailModal.classList.remove('show'));
ocrDropzone.addEventListener('click', () => ocrFileInput.click());
ocrDropzone.addEventListener('dragover', (e) => { e.preventDefault(); ocrDropzone.style.backgroundColor = '#2a2a2a'; });
ocrDropzone.addEventListener('dragleave', (e) => { ocrDropzone.style.backgroundColor = 'transparent'; });
ocrDropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    ocrDropzone.style.backgroundColor = 'transparent';
    if (e.dataTransfer.files.length > 0) handleFileSelect(e.dataTransfer.files[0]);
});
ocrFileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFileSelect(e.target.files[0]); });

document.getElementById('openModifierModalBtn').addEventListener('click', () => {
    renderModifierModal();
    modifierModal.classList.add('show');
});
document.getElementById('linkSingleModifierBtn').addEventListener('click', () => openLinkModifierModal(''));
document.getElementById('closeModifierModalBtn').addEventListener('click', () => {
    modifierModal.classList.remove('show');
});
document.getElementById('saveModifiersBtn').addEventListener('click', () => saveModifiersFromModal(true));
document.getElementById('closeLinkModifierModalBtn').addEventListener('click', () => {
    linkModifierModal.classList.remove('show');
    updateSingleProductModifierIndicator();
    generateAndRenderPricing(); // Refresh pricing to show new indicators
});


// --- ITEM LIBRARY FUNCTIONS ---
function populateStaticLibraryList(filter = '') {
    libraryListContainer.innerHTML = '';
    const normalizedFilter = filter.trim().toLowerCase();
    
    const productBaseNames = products.map(p => p._source.productName);

    const itemsToDisplay = itemLibrary.filter(item => {
        const nameMatch = item.name.toLowerCase().includes(normalizedFilter);
        const notOnList = !productBaseNames.includes(item.name);
        return nameMatch && notOnList;
    });

    if (itemsToDisplay.length === 0) {
        libraryListContainer.innerHTML = `<p style="text-align: center; color: var(--yoco-text-secondary); font-size: 14px;">Library is empty or no items match your search.</p>`;
        return;
    }

    const table = document.createElement('table');
    table.innerHTML = `
        <thead>
            <tr>
                <th>Name</th>
                <th>Category</th>
                <th>Price</th>
                <th style="text-align: right;">Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');

    itemsToDisplay.forEach(item => {
        const row = tbody.insertRow();
        const hasVariants = item.variantGroups && item.variantGroups.length > 0;
        const priceInfo = hasVariants && item.variantPricing && item.variantPricing.length > 0
            ? `From R${Math.min(...item.variantPricing.map(p => p.sellingPrice || 0)).toFixed(2)}`
            : `R${(item.price || 0).toFixed(2)}`;

        row.innerHTML = `
            <td>${item.name || 'Unnamed Item'}</td>
            <td>${item.category || 'N/A'}</td>
            <td>${priceInfo}</td>
            <td class="actions-cell" style="justify-content: flex-end;"></td>
        `;

        const actionsCell = row.querySelector('.actions-cell');

        const addBtn = document.createElement('button');
        addBtn.className = 'btn-add';
        addBtn.textContent = 'Add';
        addBtn.title = "Add directly to product list";
        addBtn.style.padding = '6px 12px';
        addBtn.onclick = () => addLibraryItemToList(item.id);
        actionsCell.appendChild(addBtn);

        const adjustBtn = document.createElement('button');
        adjustBtn.className = 'btn-export';
        adjustBtn.textContent = 'Adjust';
        adjustBtn.title = "Load into form to adjust before adding";
        adjustBtn.style.padding = '6px 12px';
        adjustBtn.onclick = () => {
            loadLibraryItemIntoForm(item.id);
            libraryModal.classList.remove('show');
        };
        actionsCell.appendChild(adjustBtn);

        if (hasVariants) {
            const viewBtn = document.createElement('button');
            viewBtn.className = 'btn-edit';
            viewBtn.title = 'View Variants';
            viewBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.816 1.201-2.083 2.24-3.668 2.843C9.879 11.832 8.12 12.5 8 12.5s-1.879-.668-3.168-1.157A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/></svg>`;
            viewBtn.onclick = () => openVariantDetailModal(item.id);
            actionsCell.appendChild(viewBtn);
        }
    });

    libraryListContainer.appendChild(table);
}

function addLibraryItemToList(itemId) {
    if (!defaultsSet) {
        showModal("Please set Session Defaults before adding items from the library.", "error");
        return;
    }
    const item = itemLibrary.find(i => i.id === itemId);
    if (!item) {
        showModal("Could not find the item in the library.", "error");
        return;
    }

    const baseName = item.name || '';
    if (products.some(p => p._source.productName === baseName)) {
        showModal(`A product named "${baseName}" is already on your list. Please use the "Adjust" button to load it into the form if you wish to create a variation.`, "error");
        return;
    }

    const data = {
        productName: baseName,
        uom: 'ea',
        prepLocation: getPrepLocation(item),
        menuCategory: item.category || '',
        productType: 'finishedGood',
        invCategory: '',
        invSubCategory: '',
        suppliedQuantity: '',
        yieldQuantity: '',
        defaultCost: 0,
        defaultPrice: isNaN(parseFloat(item.price)) ? 0 : parseFloat(item.price),
        taxApplicable: 'true',
        hasBarcode: 'no',
        barcode: '',
        customPlu: '',
        variantGroups: JSON.parse(JSON.stringify(item.variantGroups || [])),
        variantPricing: JSON.parse(JSON.stringify(item.variantPricing || [])),
        modifierGroups: JSON.parse(JSON.stringify(item.modifierGroups || [])),
        modifierLinks: {}
    };
    
    createAndAddProducts(data);
    showModal(`"${item.name}" was added to the product list.`, 'warning');
    populateStaticLibraryList(librarySearchInput.value); // Refresh library list
}

function openVariantDetailModal(itemId) {
    const item = itemLibrary.find(i => i.id === itemId);
    if (!item) return;

    document.getElementById('variantDetailModalTitle').textContent = `Variants for: ${item.name}`;
    const container = document.getElementById('variantDetailListContainer');
    container.innerHTML = '';

    const table = document.createElement('table');
    table.innerHTML = `
        <thead>
            <tr>
                <th>Variant</th>
                <th>Price</th>
                <th style="text-align: right;">Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');

    item.variantPricing.forEach(variant => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${variant.combination}</td>
            <td>R${(variant.sellingPrice || 0).toFixed(2)}</td>
            <td class="actions-cell" style="justify-content: flex-end;"></td>
        `;
        const actionsCell = row.querySelector('.actions-cell');

        const adjustBtn = document.createElement('button');
        adjustBtn.className = 'btn-export';
        adjustBtn.textContent = 'Adjust';
        adjustBtn.style.padding = '6px 12px';
        adjustBtn.onclick = () => {
            loadLibraryItemIntoForm(item.id);
            variantDetailModal.classList.remove('show');
            libraryModal.classList.remove('show');
        };
        
        actionsCell.appendChild(adjustBtn);
    });

    container.appendChild(table);
    variantDetailModal.classList.add('show');
}

function loadLibraryItemIntoForm(itemId) {
    const item = itemLibrary.find(i => i.id === itemId);
    if (!item) return;
    
    resetForm();
    
    document.getElementById('productName').value = item.name || '';
    document.getElementById('menuCategory').value = item.category || '';
    document.getElementById('prepLocation').value = getPrepLocation(item);
    document.getElementById('taxApplicable').value = 'true';
    document.getElementById('productType').value = 'finishedGood';

    if (item.variantGroups && item.variantGroups.length > 0) {
        currentVariantGroups = JSON.parse(JSON.stringify(item.variantGroups));
        currentVariantPricing = JSON.parse(JSON.stringify(item.variantPricing || []));
    } else {
        document.getElementById('sellingPrice').value = (item.price || 0).toFixed(2);
    }
    
    updateRequiredFields();
    renderVariantGroups();
    window.scrollTo({ top: document.getElementById('productForm').offsetTop, behavior: 'smooth' });
}


// --- MODIFIER MODAL & LINKING LOGIC ---
function renderModifierModal() {
    renderNewModifierGroupForm();
    renderExistingModifierGroups();
}

function renderNewModifierGroupForm() {
    newModifierGroupForm.innerHTML = `
        <div class="modifier-group-header">
            <input type="text" placeholder="New Group Name (e.g., Add-ons)" id="newModifierGroupName">
        </div>
        <div id="new-modifier-options-container">
            <div class="modifier-option-row">
                <input type="text" placeholder="Option Name" class="new-modifier-option-name">
                <input type="number" step="0.01" placeholder="Price" value="0" class="new-modifier-option-price">
                <button type="button" class="btn-remove" disabled>&ndash;</button>
            </div>
        </div>
        <button type="button" id="addNewModifierOptionBtn" class="btn-add-dynamic">Add Option</button>
        <button type="button" id="commitNewModifierGroupBtn" class="btn-add" style="margin-top:10px; width: 100%;">Add Group to Library</button>
    `;

    newModifierGroupForm.querySelector('#addNewModifierOptionBtn').onclick = () => {
        const container = newModifierGroupForm.querySelector('#new-modifier-options-container');
        const optionRow = document.createElement('div');
        optionRow.className = 'modifier-option-row';
        optionRow.innerHTML = `
            <input type="text" placeholder="Option Name" class="new-modifier-option-name">
            <input type="number" step="0.01" placeholder="Price" value="0" class="new-modifier-option-price">
            <button type="button" class="btn-remove">&ndash;</button>
        `;
        optionRow.querySelector('.btn-remove').onclick = () => optionRow.remove();
        container.appendChild(optionRow);
    };

    newModifierGroupForm.querySelector('#commitNewModifierGroupBtn').onclick = () => {
        const groupName = newModifierGroupForm.querySelector('#newModifierGroupName').value.trim();
        if (!groupName) {
            showModal("Please enter a group name for the new modifier.", "error");
            return;
        }
        if(currentModifierGroups.some(g => g.groupName.toLowerCase() === groupName.toLowerCase())) {
            showModal(`A modifier group named "${groupName}" already exists.`, "error");
            return;
        }

        const options = [];
        newModifierGroupForm.querySelectorAll('.modifier-option-row').forEach(row => {
            const name = row.querySelector('.new-modifier-option-name').value.trim();
            const price = row.querySelector('.new-modifier-option-price').value;
            if (name) {
                options.push({ name, price: parseFloat(price) || 0 });
            }
        });

        if (options.length === 0) {
            showModal("Please add at least one option to the new modifier group.", "error");
            return;
        }
        currentModifierGroups.push({ groupName, options });
        renderModifierModal();
    };
}

function renderExistingModifierGroups() {
    editModifierGroupsContainer.innerHTML = '';
    currentModifierGroups.forEach((group, groupIndex) => {
        const groupEl = document.createElement('div');
        groupEl.className = 'modifier-group-row';
        groupEl.innerHTML = `
            <div class="modifier-group-header">
                <input type="text" value="${group.groupName}" data-group-index="${groupIndex}" class="modifier-group-name-edit">
                <button type="button" class="btn-remove remove-modifier-group" data-group-index="${groupIndex}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M3 6v18h18v-18h-18zm5 14c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm4-18h-20v-2h6v-1.5c0-.827.673-1.5 1.5-1.5h5c.825 0 1.5.671 1.5 1.5v1.5h6v2z"/></svg>
                </button>
            </div>
        `;
        
        group.options.forEach((option, optionIndex) => {
            const optionRow = document.createElement('div');
            optionRow.className = 'modifier-option-row';
            optionRow.innerHTML = `
                <input type="text" value="${option.name}" data-group-index="${groupIndex}" data-option-index="${optionIndex}" class="modifier-option-name-edit">
                <input type="number" step="0.01" value="${option.price}" data-group-index="${groupIndex}" data-option-index="${optionIndex}" class="modifier-option-price-edit">
                <button type="button" class="btn-remove remove-modifier-option" data-group-index="${groupIndex}" data-option-index="${optionIndex}">&ndash;</button>
            `;
            groupEl.appendChild(optionRow);
        });

        const addOptionBtn = document.createElement('button');
        addOptionBtn.type = 'button';
        addOptionBtn.textContent = 'Add Option';
        addOptionBtn.className = 'btn-add-dynamic add-modifier-option';
        addOptionBtn.dataset.groupIndex = groupIndex;
        groupEl.appendChild(addOptionBtn);
        
        editModifierGroupsContainer.appendChild(groupEl);
    });

    editModifierGroupsContainer.querySelectorAll('.add-modifier-option').forEach(btn => btn.onclick = (e) => {
        saveModifiersFromModal(false); 
        currentModifierGroups[e.target.dataset.groupIndex].options.push({ name: '', price: 0 });
        renderExistingModifierGroups();
    });
    editModifierGroupsContainer.querySelectorAll('.remove-modifier-group').forEach(btn => btn.onclick = (e) => {
        currentModifierGroups.splice(e.currentTarget.dataset.groupIndex, 1);
        renderExistingModifierGroups();
    });
    editModifierGroupsContainer.querySelectorAll('.remove-modifier-option').forEach(btn => btn.onclick = (e) => {
        currentModifierGroups[e.currentTarget.dataset.groupIndex].options.splice(e.currentTarget.dataset.optionIndex, 1);
        renderExistingModifierGroups();
    });
}

function saveModifiersFromModal(closeModal = true) {
    const tempGroups = [];
    const groupNames = new Set();
    let hasError = false;

    editModifierGroupsContainer.querySelectorAll('.modifier-group-row').forEach((groupEl) => {
        const groupName = groupEl.querySelector('.modifier-group-name-edit').value.trim();
        if (groupName && groupNames.has(groupName.toLowerCase())) {
            showModal(`Duplicate modifier group name found: "${groupName}". Please use unique names.`, "error");
            hasError = true;
            return;
        }
        if (groupName) groupNames.add(groupName.toLowerCase());

        const options = [];
        groupEl.querySelectorAll('.modifier-option-row').forEach(optionEl => {
            const optionName = optionEl.querySelector('.modifier-option-name-edit').value.trim();
            const optionPrice = optionEl.querySelector('.modifier-option-price-edit').value;
            if (optionName) {
                options.push({ name: optionName, price: parseFloat(optionPrice) || 0 });
            }
        });
        if (groupName && options.length > 0) {
            tempGroups.push({ groupName, options });
        }
    });

    if (hasError) return;

    currentModifierGroups = tempGroups;
    if (closeModal) {
        modifierModal.classList.remove('show');
        showModal('Modifiers library updated.', 'warning');
    }
    generateAndRenderPricing();
}

function openLinkModifierModal(variantCombination) {
    linkModifierModal.dataset.activeVariant = variantCombination;
    linkModifierModalTitle.textContent = `Link Modifiers for: ${variantCombination || document.getElementById('productName').value || 'this product'}`;
    
    linkModifierListContainer.innerHTML = '';
    const linkedGroups = currentModifierLinks[variantCombination] || [];

    if (currentModifierGroups.length === 0) {
        linkModifierListContainer.innerHTML = `<p style="color: var(--yoco-text-secondary);">No modifier groups have been created yet. Close this and use the "Add/Edit Modifiers" button to create some.</p>`;
    }

    currentModifierGroups.forEach(group => {
        const item = document.createElement('div');
        item.className = 'modifier-link-item';
        const isChecked = linkedGroups.includes(group.groupName);
        const sanitizedGroupName = group.groupName.replace(/\s+/g, '-');
        item.innerHTML = `
            <input type="checkbox" id="mod-${sanitizedGroupName}" value="${group.groupName}" ${isChecked ? 'checked' : ''}>
            <label for="mod-${sanitizedGroupName}">${group.groupName}</label>
        `;
        linkModifierListContainer.appendChild(item);
        
        item.querySelector('input').onchange = (e) => {
            const groupName = e.target.value;
            const isAdding = e.target.checked;
            let currentLinks = currentModifierLinks[variantCombination] || [];
            
            if (isAdding) {
                if (!currentLinks.includes(groupName)) {
                    currentLinks.push(groupName);
                }
            } else {
                currentLinks = currentLinks.filter(name => name !== groupName);
            }
            currentModifierLinks[variantCombination] = currentLinks;
        };
    });

    const bulkSelect = document.getElementById('bulkModifierSelect');
    const bulkApplyBtn = document.getElementById('bulkApplyModifierBtn');
    bulkSelect.innerHTML = '<option value="">-- Select Group to Bulk Apply --</option>';

    currentModifierGroups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.groupName;
        option.textContent = group.groupName;
        bulkSelect.appendChild(option);
    });

    bulkApplyBtn.onclick = () => {
        const selectedGroup = bulkSelect.value;
        if (!selectedGroup) {
            showModal("Please select a modifier group to apply.", "error");
            return;
        }

        currentVariantPricing.forEach(priceItem => {
            let currentLinks = currentModifierLinks[priceItem.combination] || [];
            if (!currentLinks.includes(selectedGroup)) {
                currentLinks.push(selectedGroup);
            }
            currentModifierLinks[priceItem.combination] = currentLinks;
        });

        showModal(`"${selectedGroup}" was applied to all variants on the current form.`, 'warning');
        openLinkModifierModal(variantCombination); 
    };

    linkModifierModal.classList.add('show');
}


// --- DATA PERSISTENCE & STATE MANAGEMENT ---
function saveState() {
  console.log(`Saving state with ${products.length} products to localStorage...`);
  localStorage.setItem('productData', JSON.stringify({ products, pluCounter, sessionSite, sessionDefinePlu, defaultsSet, itemLibrary, currentModifierGroups }));
  showSaveStatus();
}

function loadState() {
  console.log("Attempting to load state from localStorage...");
  const savedData = localStorage.getItem('productData');
  if (savedData) {
    console.log("Found saved data. Parsing...");
    const state = JSON.parse(savedData);
    products = state.products || [];
    pluCounter = state.pluCounter || 1000;
    sessionSite = state.sessionSite || '';
    sessionDefinePlu = state.sessionDefinePlu || 'no';
    defaultsSet = state.defaultsSet || false;
    itemLibrary = state.itemLibrary || [];
    currentModifierGroups = state.currentModifierGroups || [];
    console.log(`${products.length} products and ${currentModifierGroups.length} modifier groups loaded.`);

    if (defaultsSet) {
        sessionSiteInput.value = sessionSite;
        sessionDefinePluSelect.value = sessionDefinePlu;
        setDefaults(true);
    }
    const sites = new Set(products.map(p => p.Site));
    const preps = new Set(products.map(p => p["Preparation Location"]));
    const menuCategories = new Set(products.map(p => p["Menu Category"]));
    const invCategories = new Set(products.map(p => p["Inventory Category"]));
    const invSubCategories = new Set(products.map(p => p["Inventory Sub-Category"]));
    
    sites.forEach(site => addToDatalist("siteList", site));
    preps.forEach(prep => addToDatalist("prepList", prep));
    menuCategories.forEach(menu => addToDatalist("menuList", menu));
    invCategories.forEach(cat => addToDatalist("inventoryCategoryList", cat));
    invSubCategories.forEach(sub => addToDatalist("inventorySubCategoryList", sub));
    updateTable();
  } else {
    console.log("No saved data found.");
  }
}

function clearAllData() {
    products = []; pluCounter = 1000; sessionSite = ''; sessionDefinePlu = 'no'; defaultsSet = false; itemLibrary = []; currentModifierGroups = [];
    localStorage.removeItem('productData');
    sessionSiteInput.value = ''; sessionDefinePluSelect.value = 'no';
    editDefaults(true);
    updateTable();
    populateStaticLibraryList();
}


// --- UI LOGIC & FORM HANDLING ---
function showSaveStatus() {
    saveStatus.style.opacity = '1';
    setTimeout(() => { saveStatus.style.opacity = '0'; }, 2000);
}
function showModal(message, type = 'error', onConfirm = null, showCancel = false) {
    modalMessage.innerHTML = message;
    customModal.querySelector('.modal-content').className = 'modal-content ' + type;
    modalActions.innerHTML = '';
    if (onConfirm) {
        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'Continue'; confirmBtn.className = 'btn-add';
        confirmBtn.onclick = () => { onConfirm(); customModal.classList.remove('show'); };
        modalActions.appendChild(confirmBtn);
    }
    if (showCancel || !onConfirm) {
        const closeBtn = document.createElement('button');
        closeBtn.textContent = onConfirm ? 'Cancel' : 'Close'; closeBtn.className = 'btn-export';
        closeBtn.onclick = () => customModal.classList.remove('show');
        modalActions.appendChild(closeBtn);
    }
    customModal.classList.add('show');
}
function confirmClearAll() {
    showModal('Are you sure you want to clear all products, session defaults, and the item library?', 'warning', () => {
            clearAllData(); showModal('All data has been cleared.', 'warning');
        }, true
    );
}
function setDefaults(isLoading = false) {
    const siteValue = sessionSiteInput.value.trim();
    if (!isLoading && siteValue === "") { showModal("Please enter a Site for this session.", "error"); return; }
    sessionSite = siteValue; sessionDefinePlu = sessionDefinePluSelect.value;
    sessionSiteInput.disabled = true; sessionDefinePluSelect.disabled = true;
    defaultsButton.textContent = "Edit Defaults"; defaultsButton.onclick = editDefaults;
    defaultsSet = true; handlePluVisibility(); if (!isLoading) saveState();
}
function editDefaults(isClearing = false) {
    sessionSiteInput.disabled = false; sessionDefinePluSelect.disabled = false;
    defaultsButton.textContent = "Set Defaults"; defaultsButton.onclick = setDefaults;
    defaultsSet = false; if (!isClearing) saveState();
}
function handlePluVisibility() {
    pluEntryGroup.style.display = (sessionDefinePlu === 'yes') ? 'flex' : 'none';
    const pluLabel = pluEntryGroup.querySelector('label');
    const hasVariants = currentVariantGroups.length > 0;

    // The user can set a custom base PLU for items with variants
    pluLabel.textContent = 'Custom Base PLU/SKU';
    document.getElementById("customPlu").placeholder = 'e.g., PIZZA-CHE';
}
function updateRequiredFields() {
    const selectedType = productTypeSelect.value;
    const inventoryCategoryLabel = document.getElementById('inventoryCategoryLabel');
    const inventorySubCategoryLabel = document.getElementById('inventorySubCategoryLabel');
    const suppliedQuantityGroup = document.getElementById('suppliedQuantityGroup');
    const suppliedQuantityLabel = document.getElementById('suppliedQuantityLabel');
    const yieldQuantityGroup = document.getElementById('yieldQuantityGroup');
    const yieldQuantityLabel = document.getElementById('yieldQuantityLabel');
    const addModifierButton = document.getElementById('openModifierModalBtn');
    const prepLocationGroup = document.getElementById('prepLocationGroup');
    const menuCategoryGroup = document.getElementById('menuCategoryGroup');
    const prepLocationInput = document.getElementById('prepLocation');
    const menuCategoryInput = document.getElementById('menuCategory');

    // Start with a baseline of what's generally visible
    costPriceGroup.style.display = 'flex';
    sellingPriceGroup.style.display = 'flex';
    prepLocationGroup.style.display = 'flex';
    menuCategoryGroup.style.display = 'flex';
    inventoryCategoryLabel.innerHTML = `Inventory Category`;
    inventorySubCategoryLabel.innerHTML = `Inventory Sub-Category`;
    suppliedQuantityGroup.style.display = 'none';
    yieldQuantityGroup.style.display = 'none';
    singleProductModifierControls.style.display = (currentVariantGroups.length === 0) ? 'flex' : 'none';
    
    // Hide price fields if variants exist, as pricing is per-variant
    if (currentVariantGroups.length > 0) {
        sellingPriceGroup.style.display = 'none';
        costPriceGroup.style.display = 'none';
    }
    
    // Apply rules based on product type
    if (selectedType === 'finishedGood') {
        costPriceGroup.style.display = 'none';
        inventoryCategoryLabel.innerHTML = `Inventory Category (Not Required)`;
        inventorySubCategoryLabel.innerHTML = `Inventory Sub-Category (Not Required)`;
    } else if (selectedType === 'rawMaterial') {
        sellingPriceGroup.style.display = 'none';
        prepLocationGroup.style.display = 'none';
        prepLocationInput.value = '';
        menuCategoryGroup.style.display = 'none';
        menuCategoryInput.value = '';
        inventoryCategoryLabel.innerHTML = `Inventory Category <span class="required-star">*</span>`;
        suppliedQuantityGroup.style.display = 'flex';
        suppliedQuantityLabel.innerHTML = `Supplied Quantity <span class="required-star">*</span>`;
    } else if (selectedType === 'finishedGood & rawMaterial') {
        inventoryCategoryLabel.innerHTML = `Inventory Category <span class="required-star">*</span>`;
        suppliedQuantityGroup.style.display = 'flex';
        suppliedQuantityLabel.innerHTML = `Supplied Quantity <span class="required-star">*</span>`;
    }
    else if (selectedType === 'Manufactured') {
        sellingPriceGroup.style.display = 'none';
        costPriceGroup.style.display = 'none';
        prepLocationGroup.style.display = 'none';
        prepLocationInput.value = '';
        menuCategoryGroup.style.display = 'none';
        menuCategoryInput.value = '';
        inventoryCategoryLabel.innerHTML = `Inventory Category <span class="required-star">*</span>`;
        yieldQuantityGroup.style.display = 'flex';
        yieldQuantityLabel.innerHTML = `Yield Quantity <span class="required-star">*</span>`;
    }

    // Disable variant/modifier buttons for non-sellable items
    const isDisabled = selectedType === 'rawMaterial' || selectedType === 'Manufactured';
    addModifierButton.disabled = isDisabled;
    addVariantGroupBtn.disabled = isDisabled;
    document.getElementById('linkSingleModifierBtn').disabled = isDisabled;

    updateSingleProductModifierIndicator();
}

function updateSingleProductModifierIndicator() {
    const indicatorWrapper = document.getElementById('singleModifierIndicator');
    indicatorWrapper.innerHTML = ''; // Clear previous content
    const count = currentModifierLinks['']?.length || 0;
    
    if (count > 0) {
        const tooltipDiv = document.createElement('div');
        tooltipDiv.className = 'tooltip modifier-indicator-wrapper';

        const indicator = document.createElement('span');
        indicator.className = 'modifier-indicator';
        indicator.textContent = count;
        
        const tooltipText = document.createElement('span');
        tooltipText.className = 'tooltiptext';
        tooltipText.innerHTML = (currentModifierLinks[''] || []).join('<br>');

        tooltipDiv.appendChild(indicator);
        tooltipDiv.appendChild(tooltipText);
        indicatorWrapper.appendChild(tooltipDiv);
    }
}
function handleInventoryCategoryChange(event) {
    const subCategories = categoryMap[event.target.value];
    if (subCategories) { subCategories.forEach(sub => addToDatalist("inventorySubCategoryList", sub)); }
}
function handleBarcodeVisibility() {
    barcodeEntryGroup.style.display = (hasBarcodeSelect.value === 'yes') ? 'flex' : 'none';
}

function addVariantGroup() {
    currentVariantGroups.push({ groupName: '', options: [{ name: '' }] });
    updateRequiredFields();
    renderVariantGroups();
}
function removeVariantGroup(groupIndex) {
    currentVariantGroups.splice(groupIndex, 1);
    updateRequiredFields();
    renderVariantGroups();
}
function addVariantOption(groupIndex) {
    currentVariantGroups[groupIndex].options.push({ name: '' });
    renderVariantGroups();
}
function removeVariantOption(groupIndex, optionIndex) {
    currentVariantGroups[groupIndex].options.splice(optionIndex, 1);
    if (currentVariantGroups[groupIndex].options.length === 0) {
        removeVariantGroup(groupIndex);
    } else {
        renderVariantGroups();
    }
}
function renderVariantGroups() {
    variantGroupsContainer.innerHTML = '';
    currentVariantGroups.forEach((group, groupIndex) => {
        const groupEl = document.createElement('div');
        groupEl.className = 'variant-group-row';

        const header = document.createElement('div');
        header.className = 'variant-group-header';
        const groupNameInput = document.createElement('input');
        groupNameInput.type = 'text';
        groupNameInput.placeholder = 'Group Name (e.g., Size)';
        groupNameInput.value = group.groupName;
        groupNameInput.oninput = (e) => {
            currentVariantGroups[groupIndex].groupName = e.target.value;
            generateAndRenderPricing();
        };
        header.appendChild(groupNameInput);
        const removeGroupBtn = document.createElement('button');
        removeGroupBtn.type = 'button';
        removeGroupBtn.className = 'btn-remove';
        removeGroupBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M3 6v18h18v-18h-18zm5 14c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm4-18h-20v-2h6v-1.5c0-.827.673-1.5 1.5-1.5h5c.825 0 1.5.671 1.5 1.5v1.5h6v2z"/></svg>`;
        removeGroupBtn.onclick = () => removeVariantGroup(groupIndex);
        header.appendChild(removeGroupBtn);
        groupEl.appendChild(header);

        group.options.forEach((option, optionIndex) => {
            const optionRow = document.createElement('div');
            optionRow.className = 'variant-option-row';
            const optionNameInput = document.createElement('input');
            optionNameInput.type = 'text';
            optionNameInput.placeholder = `Option ${optionIndex + 1} Name (e.g., Small)`;
            optionNameInput.value = option.name;
            optionNameInput.oninput = (e) => {
                currentVariantGroups[groupIndex].options[optionIndex].name = e.target.value;
                generateAndRenderPricing();
            };
            optionRow.appendChild(optionNameInput);
            const removeOptionBtn = document.createElement('button');
            removeOptionBtn.type = 'button';
            removeOptionBtn.className = 'btn-remove';
            removeOptionBtn.innerHTML = `&ndash;`;
            removeOptionBtn.onclick = () => removeVariantOption(groupIndex, optionIndex);
            optionRow.appendChild(removeOptionBtn);
            groupEl.appendChild(optionRow);
        });

        const addOptionBtn = document.createElement('button');
        addOptionBtn.type = 'button';
        addOptionBtn.textContent = 'Add Option';
        addOptionBtn.className = 'btn-add-dynamic';
        addOptionBtn.style.alignSelf = 'flex-start';
        addOptionBtn.style.marginLeft = '20px';
        addOptionBtn.onclick = () => addVariantOption(groupIndex);
        groupEl.appendChild(addOptionBtn);

        variantGroupsContainer.appendChild(groupEl);
    });
    generateAndRenderPricing();
    handlePluVisibility();
    updateRequiredFields();
}
function generateAndRenderPricing() {
    const validGroups = currentVariantGroups.filter(g => g.groupName.trim() && g.options.some(o => o.name.trim()));
    pricingColumn.style.display = (validGroups.length > 0) ? 'block' : 'none';
    variantPricingContainer.innerHTML = '';

    if (validGroups.length === 0) {
        currentVariantPricing = [];
        updateRequiredFields();
        return;
    }

    const defaultPrice = document.getElementById('sellingPrice').value;

    // Add "Apply Price to All" controls
    const pricingControls = document.createElement('div');
    pricingControls.className = 'pricing-controls';
    pricingControls.innerHTML = `
        <input type="number" id="bulkPriceInput" placeholder="Set price for all" step="0.01" value="${defaultPrice || ''}">
        <button type="button" id="applyBulkPriceBtn" class="btn-add btn-add-dynamic">Apply to all</button>
    `;
    variantPricingContainer.appendChild(pricingControls);
    document.getElementById('applyBulkPriceBtn').onclick = () => {
        const price = document.getElementById('bulkPriceInput').value;
        if (price !== '' && !isNaN(price)) {
            currentVariantPricing.forEach(p => p.sellingPrice = parseFloat(price));
            generateAndRenderPricing(); // Re-render to update fields
        }
    };


    const arraysToCombine = validGroups.map(g => g.options.filter(o => o.name.trim()).map(o => ({ groupName: g.groupName.trim(), optionName: o.name.trim() })));
    
    const cartesian = (...a) => a.reduce((A, B) => A.flatMap(x => B.map(y => [...x, y])), [[]]);
    const combinations = cartesian(...arraysToCombine);

    const newPricingData = combinations.map(combo => {
        const combinationString = combo.map(c => `${c.groupName}: ${c.optionName}`).join('; ');
        const existing = currentVariantPricing.find(p => p.combination === combinationString);
        return {
            combination: combinationString,
            sellingPrice: existing ? existing.sellingPrice : '',
            costPrice: existing ? existing.costPrice : ''
        };
    });
    currentVariantPricing = newPricingData;
    
    const productType = document.getElementById('productType').value;

    currentVariantPricing.forEach((priceItem, index) => {
        const row = document.createElement('div');
        row.className = 'variant-pricing-row';
        row.style.gridTemplateColumns = '2fr 1fr auto'; // Adjusted base columns
        
        const nameEl = document.createElement('span');
        nameEl.className = 'combo-name';
        nameEl.textContent = priceItem.combination;
        
        const spInput = document.createElement('input');
        spInput.type = 'number'; spInput.step = '0.01'; spInput.placeholder = 'Selling Price*';
        spInput.value = priceItem.sellingPrice;
        spInput.oninput = (e) => currentVariantPricing[index].sellingPrice = e.target.value;
        
        const actionsWrapper = document.createElement('div');
        actionsWrapper.style.display = 'flex';
        actionsWrapper.style.alignItems = 'center';
        actionsWrapper.style.gap = '8px';

        const linkBtn = document.createElement('button');
        linkBtn.type = 'button';
        linkBtn.textContent = 'Link Modifier';
        linkBtn.title = 'Link Modifiers';
        linkBtn.className = 'btn-add btn-add-dynamic';
        linkBtn.onclick = () => openLinkModifierModal(priceItem.combination);
        
        row.appendChild(nameEl);
        row.appendChild(spInput);

        if (productType !== 'finishedGood') {
            const cpInput = document.createElement('input');
            cpInput.type = 'number'; cpInput.step = '0.01'; cpInput.placeholder = 'Cost Price';
            cpInput.value = priceItem.costPrice;
            cpInput.oninput = (e) => currentVariantPricing[index].costPrice = e.target.value;
            row.appendChild(cpInput);
            row.style.gridTemplateColumns = '2fr 1fr 1fr auto'; // Restore original columns
        }
        
        const linkedModifiers = currentModifierLinks[priceItem.combination] || [];
        if (linkedModifiers.length > 0) {
            const tooltipDiv = document.createElement('div');
            tooltipDiv.className = 'tooltip modifier-indicator-wrapper';

            const indicator = document.createElement('span');
            indicator.className = 'modifier-indicator';
            indicator.textContent = linkedModifiers.length;
            
            const tooltipText = document.createElement('span');
            tooltipText.className = 'tooltiptext';
            tooltipText.innerHTML = linkedModifiers.join('<br>');

            tooltipDiv.appendChild(indicator);
            tooltipDiv.appendChild(tooltipText);
            actionsWrapper.appendChild(tooltipDiv);
        }
        
        actionsWrapper.appendChild(linkBtn);
        row.appendChild(actionsWrapper);
        variantPricingContainer.appendChild(row);
    });
    updateRequiredFields();
}


// --- MAIN FORM ACTIONS, PRODUCT HANDLING ---
function handleMainAction() {
    const editingIndex = parseInt(editingIndexInput.value, 10);
    if (editingIndex > -1) {
        updateProduct(editingIndex);
    } else {
        addProduct();
    }
}
function validateForm() {
    const baseProductName = document.getElementById("productName").value.trim();
    const uom = document.getElementById("uom").value;
    const prep = document.getElementById("prepLocation").value.trim();
    const menu = document.getElementById("menuCategory").value.trim();
    const productType = document.getElementById("productType").value;
    const invCat = document.getElementById("inventoryCategory").value.trim();
    const suppliedQuantity = document.getElementById("suppliedQuantity").value.trim();
    const yieldQuantity = document.getElementById("yieldQuantity").value.trim();
    const defaultCost = parseFloat(document.getElementById("costPrice").value);
    const defaultPrice = parseFloat(document.getElementById("sellingPrice").value);
    const taxApplicable = document.getElementById("taxApplicable").value;
    const hasBarcode = document.getElementById("hasBarcode").value;
    const barcode = (hasBarcode === 'yes') ? document.getElementById("barcode").value.trim() : "";
    const customPlu = document.getElementById("customPlu").value.trim();
    const editingIndex = parseInt(editingIndexInput.value, 10);
    let errors = [];

    if (baseProductName === "") errors.push("Product Name is required.");
    if (!uom) errors.push("Selling UOM is required.");
    if (productType !== 'rawMaterial' && productType !== 'finishedGood & rawMaterial' && productType !== 'Manufactured' && prep === "") errors.push("Preparation Location is required.");
    if (productType !== 'rawMaterial' && productType !== 'finishedGood & rawMaterial' && productType !== 'Manufactured' && menu === "") errors.push("Menu Category is required.");
    if (!productType) errors.push("Product Type is required.");
    if (!taxApplicable) errors.push("Tax Applicable is required.");
    
    if (currentVariantGroups.length > 0) {
        currentVariantGroups.forEach((g, i) => {
            if (!g.groupName.trim()) errors.push(`Group Name is required for variant group #${i + 1}.`);
            g.options.forEach((o, j) => {
                if(!o.name.trim()) errors.push(`Option Name is required for option #${j+1} in group "${g.groupName || `#${i+1}`}".`);
            });
        });
        currentVariantPricing.forEach(p => {
            if (p.sellingPrice === '' || isNaN(parseFloat(p.sellingPrice))) {
                errors.push(`Selling price is required for variant combination "${p.combination}".`);
            }
        });
    } else {
        if ((productType === 'finishedGood' || productType === 'finishedGood & rawMaterial') && isNaN(defaultPrice)) {
            errors.push("A Default Selling Price is required if no variants are added.");
        }
        if ((productType === 'rawMaterial' || productType === 'finishedGood & rawMaterial') && isNaN(defaultCost)) {
            errors.push("A Default Cost Price is required if no variants are added.");
        }
    }

    if ((productType === 'rawMaterial' || productType === 'finishedGood & rawMaterial') && (invCat === "" || suppliedQuantity === "")) errors.push("Inv Category & Supplied Quantity are required.");
    if (productType === 'Manufactured' && (invCat === "" || yieldQuantity === "")) errors.push("Inv Category & Yield Quantity are required.");
    if (hasBarcode === 'yes' && barcode === "") errors.push("Barcode is required.");
    if (sessionDefinePlu === 'yes' && customPlu === "") errors.push("Custom Base PLU/SKU is required.");
    if (sessionDefinePlu === 'yes' && products.some((p, i) => p.pluBase === customPlu && i !== editingIndex)) errors.push(`Base PLU/SKU "${customPlu}" already exists.`);
        
    return errors;
}

function gatherProductData() {
    return {
        productName: document.getElementById("productName").value.trim(),
        uom: document.getElementById("uom").value,
        prepLocation: document.getElementById("prepLocation").value.trim(),
        menuCategory: document.getElementById("menuCategory").value.trim(),
        productType: document.getElementById("productType").value,
        invCategory: document.getElementById("inventoryCategory").value.trim(),
        invSubCategory: document.getElementById("inventorySubCategory").value.trim(),
        suppliedQuantity: document.getElementById("suppliedQuantity").value.trim(),
        yieldQuantity: document.getElementById("yieldQuantity").value.trim(),
        defaultCost: parseFloat(document.getElementById("costPrice").value),
        defaultPrice: parseFloat(document.getElementById("sellingPrice").value),
        taxApplicable: document.getElementById("taxApplicable").value,
        hasBarcode: document.getElementById("hasBarcode").value,
        barcode: (document.getElementById("hasBarcode").value === 'yes') ? document.getElementById("barcode").value.trim() : "",
        customPlu: document.getElementById("customPlu").value.trim(),
        variantGroups: JSON.parse(JSON.stringify(currentVariantGroups)),
        variantPricing: JSON.parse(JSON.stringify(currentVariantPricing)),
        modifierGroups: JSON.parse(JSON.stringify(currentModifierGroups)),
        modifierLinks: JSON.parse(JSON.stringify(currentModifierLinks))
    };
}

function addProduct() {
    if (!defaultsSet) { showModal("Please set Session Defaults first.", "error"); return; }
    const errors = validateForm();
    if (errors.length > 0) { showModal("Please fix the following issues:\n- " + errors.join("\n- "), "error"); return; }
    
    const data = gatherProductData();
    const hasZeroPriceVariant = data.variantPricing.length > 0 && data.variantPricing.some(v => parseFloat(v.sellingPrice) === 0);
    if (hasZeroPriceVariant) {
        showModal('Some variants have R0.00 price. Continue?', 'warning', () => createAndAddProducts(data), true);
    } else {
        createAndAddProducts(data);
    }
}

function createAndAddProducts(data, existingPluBase = null) {
    const combinationsToProcess = data.variantPricing.length > 0 
        ? data.variantPricing 
        : [{ combination: '', sellingPrice: data.defaultPrice, costPrice: data.defaultCost }];
    
    // Determine the single, unique Base PLU for this entire group.
    const pluBase = existingPluBase || (sessionDefinePlu === 'yes' && data.customPlu ? data.customPlu : "PLU-" + (++pluCounter));

    let potentialProductsToAdd = [];
    let nameErrors = [];

    combinationsToProcess.forEach((combo) => {
        let prefixedBaseName = data.productName;
        if (data.productType === "rawMaterial") prefixedBaseName = "(RAW) " + data.productName;
        else if (data.productType === "Manufactured") prefixedBaseName = "(MAN) " + data.productName;

        const finalName = (combo.combination && combo.combination.trim() !== "") ? `${prefixedBaseName} - ${combo.combination.trim()}` : prefixedBaseName;
        if (products.some(p => p["Product Name & Variant"] === finalName && p._source.productName === data.productName)) { 
            nameErrors.push(`Product "${finalName}" already exists.`);
        }

        const linkedModifierGroupNames = data.modifierLinks[combo.combination] || [];
        const modifierString = linkedModifierGroupNames.join(', ');
        
        potentialProductsToAdd.push({
            finalName, prefixedBaseName, variantName: combo.combination ? combo.combination.trim() : '',
            sellingPrice: parseFloat(combo.sellingPrice),
            costPrice: parseFloat(combo.costPrice),
            modifierString
        });
    });

    if (nameErrors.length > 0) { showModal("Please fix issues:\n- " + nameErrors.join("\n- "), "error"); return; }
    
    const newProductStartIndex = products.length;
    let internalProductType = data.productType === 'Manufactured' ? 'preparation' : 'single';
    
    potentialProductsToAdd.forEach((item, index) => {
        const finalPrice = isNaN(item.sellingPrice) ? 0 : item.sellingPrice;
        const finalCost = isNaN(item.costPrice) ? 0 : item.costPrice;
        const gp = (finalPrice > 0) ? ((finalPrice - finalCost) / finalPrice) * 100 : 0;
        
        let productPlu = (combinationsToProcess.length > 1) ? `${pluBase}-${index + 1}` : pluBase;
        
        const product = {
          "pluBase": pluBase, // Explicitly store the Base PLU for grouping
          "_source": data,
          "Product PLU": productPlu, "Product Name & Variant": item.finalName, "Base Name": item.prefixedBaseName,
          "Variant Name": item.variantName, "Original Product Type": data.productType, "Site": sessionSite,
          "GP": gp, "Selling UOM": data.uom, "Preparation Location": data.prepLocation, "Menu Category": data.menuCategory,
          "Inventory Category": data.invCategory, "Inventory Sub-Category": data.invSubCategory,
          "Product Type": internalProductType,
          "Supplied Quantity": (data.productType === 'rawMaterial' || data.productType === 'finishedGood & rawMaterial') ? data.suppliedQuantity : '',
          "Manufactured Yield": (data.productType === 'Manufactured') ? data.yieldQuantity : '',
          "Enabled": true, "Cost Price": finalCost, "Selling Price": finalPrice,
          "Tax Applicable": data.taxApplicable === 'true',
          "Modifier": item.modifierString, "Barcode": data.barcode
        };
        products.push(product);
    });

    saveState();
    updateTable(newProductStartIndex);
    addToDatalist("prepList", data.prepLocation); addToDatalist("menuList", data.menuCategory);
    addToDatalist("inventoryCategoryList", data.invCategory); addToDatalist("inventorySubCategoryList", data.invSubCategory);
    resetForm();
    document.getElementById("productName").focus();
}

function updateProduct(index) {
    const errors = validateForm();
    if (errors.length > 0) { showModal("Please fix issues:\n- " + errors.join("\n- "), "error"); return; }
    
    const data = gatherProductData();
    const originalProduct = products[index];

    // **BUG FIX: Use the robust `pluBase` property for updating**
    if (!originalProduct || !originalProduct.pluBase) {
        showModal('This is an older product without a Base PLU. It cannot be safely edited. Please remove and re-add it to ensure data integrity.', 'error');
        return;
    }
    const pluBaseToUpdate = originalProduct.pluBase;

    // Remove all items belonging to the same group, identified by the exact pluBase
    products = products.filter(p => p.pluBase !== pluBaseToUpdate);

    // Re-create the products with the updated data, reusing the original pluBase
    createAndAddProducts(data, pluBaseToUpdate);
    
    resetForm();
    showModal('Product updated successfully!', 'warning');
}

function editProduct(index) {
    const product = products[index];
    if (!product || !product._source) {
        showModal('This product cannot be edited as it was created with an older version.', 'error');
        return;
    }

    if (!product.pluBase) {
        showModal('This is an older product without a Base PLU. It cannot be safely edited. Please remove and re-add it to ensure data integrity.', 'error');
        return;
    }
    
    const relatedProducts = products.filter(p => p.pluBase === product.pluBase);
    if (relatedProducts.length > 1) {
        showModal(`This product has ${relatedProducts.length-1} other variants. Editing it will affect all of them. Do you want to continue?`, 'warning', () => proceedWithEdit(product, index), true);
    } else {
        proceedWithEdit(product, index);
    }
}

function proceedWithEdit(product, index) {
    const source = product._source;
    editingIndexInput.value = index;

    document.getElementById("productName").value = source.productName;
    document.getElementById("taxApplicable").value = source.taxApplicable;
    document.getElementById("productType").value = source.productType;
    document.getElementById("uom").value = source.uom;
    document.getElementById("prepLocation").value = source.prepLocation;
    document.getElementById("menuCategory").value = source.menuCategory;
    document.getElementById("inventoryCategory").value = source.invCategory;
    document.getElementById("inventorySubCategory").value = source.invSubCategory;
    document.getElementById("suppliedQuantity").value = source.suppliedQuantity;
    document.getElementById("yieldQuantity").value = source.yieldQuantity;
    document.getElementById("costPrice").value = isNaN(source.defaultCost) ? '' : source.defaultCost;
    document.getElementById("sellingPrice").value = isNaN(source.defaultPrice) ? '' : source.defaultPrice;
    document.getElementById("hasBarcode").value = source.hasBarcode;
    document.getElementById("barcode").value = source.barcode;
    
    // Set the customPlu field to the group's base PLU
    document.getElementById("customPlu").value = product.pluBase;
    
    currentVariantGroups = JSON.parse(JSON.stringify(source.variantGroups || []));
    currentVariantPricing = JSON.parse(JSON.stringify(source.variantPricing || []));
    currentModifierGroups = JSON.parse(JSON.stringify(source.modifierGroups || []));
    currentModifierLinks = JSON.parse(JSON.stringify(source.modifierLinks || {}));
    
    updateRequiredFields();
    renderVariantGroups();
    handleBarcodeVisibility();
    handlePluVisibility();

    mainActionButton.textContent = 'Update Product';
    mainActionButton.classList.replace('btn-add', 'btn-update');

    document.querySelectorAll('#productTable tbody tr').forEach(row => {
        row.classList.remove('editing-row');
    });
    
    const rowsToHighlight = products.filter(p => p.pluBase === product.pluBase).map(p => p['Product PLU']);
    document.querySelectorAll('#productTable tbody tr').forEach(row => {
        const rowPlu = row.cells[0].textContent;
        if (rowsToHighlight.includes(rowPlu)) {
            row.classList.add('editing-row');
        }
    });

    window.scrollTo({ top: document.getElementById('productForm').offsetTop, behavior: 'smooth' });
}


function resetForm() {
    document.getElementById('productForm').reset();
    document.getElementById('uom').value = 'ea';
    editingIndexInput.value = '-1';
    currentVariantGroups = [];
    currentVariantPricing = [];
    currentModifierLinks = {};
    
    mainActionButton.textContent = 'Add Product';
    mainActionButton.classList.replace('btn-update', 'btn-add');
    
    document.querySelectorAll('.editing-row').forEach(row => row.classList.remove('editing-row'));
    
    renderVariantGroups();
    updateRequiredFields();
    handleBarcodeVisibility();
}


function updateTable(newProductStartIndex = -1) {
  const tbody = document.querySelector("#productTable tbody");
  tbody.innerHTML = "";
  products.forEach((p, index) => {
    const row = document.createElement("tr");
    if (index >= newProductStartIndex) { row.classList.add('new-row'); }
    
    const columnOrder = [
        "Product PLU", "Base Name", "Variant Name", "Site", "GP", "Selling UOM",
        "Preparation Location", "Menu Category", "Inventory Category", "Inventory Sub-Category",
        "Product Type", "Enabled", "Cost Price", "Selling Price",
        "Tax Applicable", "Modifier", "Barcode"
    ];

    columnOrder.forEach(key => {
        const cell = document.createElement("td");
        let value = p[key];
        if (typeof value === 'boolean') value = value.toString().toUpperCase();
        if (key === "GP" || key === "Cost Price" || key === "Selling Price") value = (typeof value === 'number') ? value.toFixed(2) : '0.00';
        cell.textContent = value;
        row.appendChild(cell);
    });

    const actionsCell = document.createElement("td");
    actionsCell.className = "actions-cell";
    
    const editBtn = document.createElement("button");
    editBtn.className = "btn-edit";
    editBtn.title = "Edit Product";
    editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M19.769 9.923l-12.642 12.639-7.127 1.438 1.438-7.127 12.641-12.64 5.69 5.691zm1.414-1.414l2.817-2.817-5.691-5.69-2.816 2.817 5.69 5.69z"/></svg>`;
    editBtn.onclick = () => editProduct(index);
    
    const removeBtn = document.createElement("button");
    removeBtn.className = "btn-remove";
    removeBtn.title = "Remove Product";
    removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path d="M3 6v18h18v-18h-18zm5 14c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm5 0c0 .552-.448 1-1 1s-1-.448-1-1v-10c0-.552.448-1 1-1s1 .448 1 1v10zm4-18h-20v-2h6v-1.5c0-.827.673-1.5 1.5-1.5h5c.825 0 1.5.671 1.5 1.5v1.5h6v2z"/></svg>`;
    removeBtn.onclick = () => { 
        const pluBaseToRemove = p.pluBase;
        let productCount;
        let baseNameForMessage = p["Base Name"];

        if (pluBaseToRemove) {
            productCount = products.filter(prod => prod.pluBase === pluBaseToRemove).length;
        } else {
            // Fallback for very old data without pluBase
            const classicPluBase = p['Product PLU'].split('-')[0];
            productCount = products.filter(prod => prod['Product PLU'].startsWith(classicPluBase)).length;
        }

        const message = productCount > 1 
            ? `Remove "${baseNameForMessage}" and its ${productCount-1} other variants?`
            : `Remove "${p["Product Name & Variant"]}"?`;
        
        showModal(message, 'warning', () => { 
            if (pluBaseToRemove) {
                products = products.filter(prod => prod.pluBase !== pluBaseToRemove);
            } else {
                const classicPluBase = p['Product PLU'].split('-')[0];
                products = products.filter(prod => !prod['Product PLU'].startsWith(classicPluBase));
            }
            saveState(); 
            updateTable(); 
        }, true); 
    };
    
    actionsCell.appendChild(editBtn);
    actionsCell.appendChild(removeBtn);
    row.appendChild(actionsCell);
    tbody.appendChild(row);
  });
  if (newProductStartIndex !== -1) { setTimeout(() => { document.querySelectorAll('.new-row').forEach(r => r.classList.remove('new-row')); }, 2500); }
}

function exportToExcel() {
    if (products.length === 0) {
        showModal("No products to export!", "warning");
        return;
    }

    const videoOverlay = document.getElementById('videoOverlay');
    const exportVideo = document.getElementById('exportVideo');

    // Main sheet data with simplified modifier column
    const exportData = products.map(p => {
        let inventoryCategory = p["Inventory Category"];
        if (inventoryCategory) { 
            switch (p["Original Product Type"]) {
                case "finishedGood": inventoryCategory += " - FINISHED GOOD"; break;
                case "rawMaterial": case "finishedGood & rawMaterial": inventoryCategory += " - RAW MATERIALS"; break;
                case "Manufactured": inventoryCategory += " - MANUFACTURED"; break;
            }
        }
        let finalCostPrice = p["Cost Price"];
        if ((p["Original Product Type"] === 'rawMaterial' || p["Original Product Type"] === 'finishedGood & rawMaterial') && p["Supplied Quantity"] && p["Supplied Quantity"] > 0) {
            finalCostPrice = p["Cost Price"] / p["Supplied Quantity"];
        }

        const variantName = p["Variant Name"] || '';
        const linkedGroups = p._source?.modifierLinks?.[variantName] || [];
        const modifierColumnValue = linkedGroups.join(', ');

        return {
          "Product PLU": p["Product PLU"], "Product Name & Variant": p["Product Name & Variant"], "Site": p.Site,
          "GP": p["GP"], "Selling UOM": p["Selling UOM"], "Preparation Location": p["Preparation Location"],
          "Menu Category": p["Menu Category"], "Inventory Category": inventoryCategory, "Inventory Sub-Category": p["Inventory Sub-Category"],
          "Product Type": p["Product Type"], "Enabled": p.Enabled, "Cost Price": finalCostPrice, "Selling Price": p["Selling Price"],
          "Dynamic Price": false, "Visible on App": false, "Default Selling Location": "Default Selling Location", "Default Storage Location": "Default Storage Location",
          "Tax Applicable": p["Tax Applicable"], "Modifier": modifierColumnValue,
          "Barcode": p.Barcode, "Supplied Quantity": p["Supplied Quantity"] ? `${p["Supplied Quantity"]} ${p["Selling UOM"]}` : '',
          "Supplied Quantity Cost Price": p["Supplied Quantity"] ? p["Cost Price"] : '', "Manufactured Yield": p["Manufactured Yield"],
          "Product PLU (End)": p["Product PLU"], "Product Name": p["Base Name"],
          "Variant": p["Variant Name"] ? p["Variant Name"] : "", "Listed Product Type": p["Original Product Type"]
        };
    });

    // Second sheet data
    const createProductStructureData = products.map(p => ({
        "Product PLU": p["Product PLU"], "Name": p["Base Name"],
        "Variants": p["Variant Name"] ? p["Variant Name"] : "",
        "Menu Categories": p["Menu Category"], "Inventory Type": p["Original Product Type"], "Tags": "",
        "Selling UOM": p["Selling UOM"], "Tax Applicable": p["Tax Applicable"], "Show on Royalty": false,
        "Inventory Category": p["Inventory Category"], "Inventory Sub-Category": p["Inventory Sub-Category"],
        "Barcodes": p.Barcode, "Product SKU": p["Product PLU"], "Description": ""
    }));

    // Third sheet data (Modifier Groups)
    const modifierSheetData = [];
    if (currentModifierGroups.length > 0) {
        currentModifierGroups.forEach(group => {
            const linkedProductsForGroup = products
                .filter(p => {
                    const variantName = p["Variant Name"] || '';
                    const linkedGroups = p._source?.modifierLinks?.[variantName] || [];
                    return linkedGroups.includes(group.groupName);
                })
                .map(p => p["Product Name & Variant"]);

            modifierSheetData.push({ "Line Item": `MODIFIER GROUP: ${group.groupName}`, "Details": "" });
            modifierSheetData.push({ "Line Item": "Options", "Details": "Price" });
            if (group.options && group.options.length > 0) {
                group.options.forEach(option => {
                    modifierSheetData.push({ "Line Item": option.name, "Details": (option.price || 0).toFixed(2) });
                });
            } else {
                modifierSheetData.push({ "Line Item": "(No options defined)", "Details": "" });
            }

            modifierSheetData.push({}); 
            modifierSheetData.push({ "Line Item": "Linked Selling Products", "Details": `(${linkedProductsForGroup.length} item/s)` });
            if (linkedProductsForGroup.length > 0) {
                linkedProductsForGroup.forEach(productName => {
                    modifierSheetData.push({ "Line Item": productName, "Details": "" });
                });
            } else {
                modifierSheetData.push({ "Line Item": "(Not linked to any products on the list)", "Details": "" });
            }
            
            modifierSheetData.push({});
            modifierSheetData.push({});
        });
    } else {
        modifierSheetData.push({ "Line Item": "No modifier groups have been created.", "Details": "" });
    }

    const ws1 = XLSX.utils.json_to_sheet(exportData);
    const ws2 = XLSX.utils.json_to_sheet(createProductStructureData);
    const ws3 = XLSX.utils.json_to_sheet(modifierSheetData, {skipHeader: false});
    ws3['!cols'] = [ {wch:60}, {wch:20} ];
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws1, "Site Product Structure");
    XLSX.utils.book_append_sheet(wb, ws2, "Create Product structure");
    XLSX.utils.book_append_sheet(wb, ws3, "Modifier Groups");
  
    XLSX.writeFile(wb, "products.xlsx");

    videoOverlay.style.display = 'flex';
    exportVideo.currentTime = 0;
    exportSoundElement.currentTime = 0;
    exportVideo.play();
    exportSoundElement.play();

    exportVideo.onended = () => {
        videoOverlay.style.display = 'none';
        showModal('Export successful! Clear all data?', 'warning', () => clearAllData(), true);
    };
}
function addToDatalist(id, value) {
  if (!value) return; 
  const datalist = document.getElementById(id);
  if (!datalist) {
      console.error(`Datalist with id "${id}" not found.`);
      return;
  }
  if (![...datalist.options].some(o => o.value === value)) {
    const opt = document.createElement("option"); opt.value = value; datalist.appendChild(opt);
  }
}

// --- OCR/AI FUNCTIONALITY ---
function getPrepLocation(item) {
    const name = (item.name || '').toLowerCase();
    const category = (item.category || '').toLowerCase();
    const drinkKeywords = ['drink', 'coke', 'fanta', 'juice', 'coffee', 'tea', 'cappuccino', 'latte', 'beer', 'wine', 'soda', 'beverage'];
    
    if (drinkKeywords.some(kw => name.includes(kw) || category.includes(kw))) {
        return 'Bar';
    }
    return 'Kitchen';
}

function handleFileSelect(file) {
    ocrLoader.style.display = 'block';
    ocrDropzone.style.display = 'none';
    const onProgress = (status) => { ocrStatus.textContent = status; };

    const loaderGif1 = document.getElementById('loaderGif1');
    const loaderGif2 = document.getElementById('loaderGif2');
    loaderGif1.style.display = 'block';
    loaderGif2.style.display = 'none';

    if (loaderInterval) clearInterval(loaderInterval);
    loaderInterval = setInterval(() => {
        if (loaderGif1.style.display === 'block') {
            loaderGif1.style.display = 'none';
            loaderGif2.style.display = 'block';
        } else {
            loaderGif1.style.display = 'block';
            loaderGif2.style.display = 'none';
        }
    }, 1000);

    const stopLoader = () => {
        if (loaderInterval) clearInterval(loaderInterval);
        loaderInterval = null;
        ocrLoader.style.display = 'none';
    };

    processFileWithOCR(file, onProgress)
        .then(ocrData => {
            stopLoader();
            displayOcrResults(ocrData);
        })
        .catch(err => {
            stopLoader();
            showModal(`Error processing menu: ${err.message}`, 'error');
            ocrDropzone.style.display = 'block';
        });
}

function displayOcrResults(items) {
    ocrResultsContainer.innerHTML = '';
    if (items.length === 0) {
        ocrStatus.textContent = 'No menu items could be extracted. Please try another image or a clearer page.';
        return;
    }

    let itemsAdded = 0;
    items.forEach(item => {
        if (item.name && !itemLibrary.some(libItem => libItem.name.toLowerCase() === item.name.toLowerCase())) {
            itemLibrary.push(item);
            itemsAdded++;
        }
    });
    if (itemsAdded > 0) {
        saveState();
    }

    ocrStatus.textContent = `Found ${items.length} items. Choose an action for each item below.`;
    
    items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'ocr-item';
        
        const priceInfo = (item.variantPricing && item.variantPricing.length > 0)
            ? `From R${Math.min(...item.variantPricing.map(p => p.sellingPrice || 0)).toFixed(2)}`
            : `R${(item.price || 0).toFixed(2)}`;
        
        itemEl.innerHTML = `
            <div class="ocr-item-info">
                <div class="ocr-item-name">${item.name || 'Unnamed Item'}</div>
                <div class="ocr-item-details">Category: ${item.category || 'N/A'} | Price: ${priceInfo}</div>
            </div>
            <div class="ocr-item-actions">
                <button class="btn-export">Adjust</button>
            </div>
        `;
        
        itemEl.querySelector('.btn-export').onclick = () => {
            loadOcrItemIntoForm(item);
            ocrModal.classList.remove('show');
        };
        ocrResultsContainer.appendChild(itemEl);
    });
}

function loadOcrItemIntoForm(item) {
    resetForm();
    
    document.getElementById('productName').value = item.name || '';
    document.getElementById('menuCategory').value = item.category || '';
    document.getElementById('prepLocation').value = getPrepLocation(item);
    document.getElementById('taxApplicable').value = 'true';
    document.getElementById('productType').value = 'finishedGood';

    if (item.variantGroups && item.variantGroups.length > 0) {
        currentVariantGroups = JSON.parse(JSON.stringify(item.variantGroups));
        currentVariantPricing = JSON.parse(JSON.stringify(item.variantPricing || []));
    } else {
        document.getElementById('sellingPrice').value = (item.price || 0).toFixed(2);
    }

    if(item.modifierGroups && item.modifierGroups.length > 0) {
        currentModifierGroups = JSON.parse(JSON.stringify(item.modifierGroups));
    }

    updateRequiredFields();
    renderVariantGroups();
    window.scrollTo({ top: document.getElementById('productForm').offsetTop, behavior: 'smooth' });
}

async function getMenuDataFromAI(base64String, mimeType) {
    if (!GOOGLE_API_KEY || GOOGLE_API_KEY === 'PASTE_YOUR_GEMINI_API_KEY_HERE') {
        throw new Error("Configuration Error: Google Gemini API Key is not set in config.js.");
    }
    const model = 'gemini-1.5-flash-latest';
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GOOGLE_API_KEY}`;
    const prompt = `You are a world-class menu data extraction AI. Your task is to extract all item data as accurately as possible from the menu image. Each menu item listed should be treated as a unique product. **MASTER INSTRUCTIONS:** 1. **ITEM SPLITTING (IMPORTANT):** If a single line item lists multiple product names joined by commas or words like "OR" that share a single price (e.g., "Coke, Fanta or Sprite @ R20"), you **MUST** create a separate, individual product entry for each one. 2. **ITEM IDENTIFICATION:** Each distinct item on the menu is its own product. **"name"**: Extract the full, unique product name as it appears on the menu (e.g., "Pepperoni Deluxe"). 3. **JSON STRUCTURE:** - **"name"**: The full product name. - **"category"**: The menu category. - **"price"**: The base price of the item (lowest price). - **"variantGroups"**: A list of variant groups. Each group MUST have a 'groupName' and an 'options' array. Each option MUST have a 'name' property. - **"variantPricing"**: A list of all individual variant combinations and their full prices. Each item MUST have a 'combination' string (e.g., "Size: Small; Base: Thin") and a 'sellingPrice' number. - **"modifierGroups"**: For optional add-ons. 4. **FINAL CHECK:** Ensure the final output is ONLY a valid JSON array. Do not wrap it in markdown backticks or add any conversational text before or after the JSON. Prices must be numbers (e.g., \`42.90\`), not strings.`;
    const requestPayload = { contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: mimeType, data: base64String } } ] }] };
    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestPayload) });
    if (!response.ok) { const errorBody = await response.json(); throw new Error(`API request failed: ${errorBody.error.message}`); }
    const responseData = await response.json();
    const jsonText = responseData.candidates[0].content.parts[0].text;
    const jsonMatch = jsonText.match(/(\[[\s\S]*\]|\{[\s\S]*\})/);
    if (!jsonMatch) {
        console.error("AI did not return a valid JSON structure. Raw response:", jsonText);
        throw new Error("Could not find a valid JSON array or object in the AI's response.");
    }
    const cleanJsonString = jsonMatch[0].replace(/,(?=\s*[}\]])/g, '');
    return JSON.parse(cleanJsonString);
}

function processFileWithOCR(file, onProgress) {
    return new Promise(async (resolve, reject) => {
        try {
            let allItems = [];
            onProgress('Preparing file...');
            if (file.type === 'application/pdf') {
                const pdfjsLib = window['pdfjs-dist/build/pdf'];
                pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const pdf = await pdfjsLib.getDocument(event.target.result).promise;
                        for (let i = 1; i <= pdf.numPages; i++) {
                            onProgress(`Processing page ${i} of ${pdf.numPages}...`);
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            canvas.height = viewport.height; canvas.width = viewport.width;
                            const context = canvas.getContext('2d');
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            const base64String = canvas.toDataURL('image/png').split(',')[1];
                            const pageItems = await getMenuDataFromAI(base64String, 'image/png');
                            allItems.push(...pageItems);
                        }
                        finalizeProcessing(allItems, onProgress, resolve);
                    } catch (pdfError) { reject(pdfError); }
                };
                reader.onerror = reject; reader.readAsArrayBuffer(file);
            } else {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const base64String = event.target.result.split(',')[1];
                    onProgress('Analyzing menu with AI...');
                    allItems = await getMenuDataFromAI(base64String, file.type);
                    finalizeProcessing(allItems, onProgress, resolve);
                };
                reader.onerror = reject; reader.readAsDataURL(file);
            }
        } catch (error) { reject(error); }
    });
}

function finalizeProcessing(menuData, onProgress, resolve) {
    const correctPrice = (price) => (typeof price !== 'number') ? 0 : (price > 1000 ? price / 100 : price);
    const normalizedMenuData = menuData.map((item, index) => {
        const newItem = { ...item, id: (Date.now() + index), price: correctPrice(item.price) };
        if (Array.isArray(newItem.modifierGroups)) {
            newItem.modifierGroups.forEach(group => {
                if (Array.isArray(group.options)) group.options.forEach(option => { option.price = correctPrice(option.price); });
            });
        }
        if (Array.isArray(newItem.variantPricing)) {
            newItem.variantPricing.forEach(vp => { vp.sellingPrice = correctPrice(vp.sellingPrice); });
        }
        return newItem;
    });
    onProgress('Processing complete!');
    resolve(normalizedMenuData);
}

</script>
</body>
</html>
